{% extends "base.html" %}
{% block title %}Manage Instructors{% endblock %}
{% block content %}
<div class="card">
    <h2>Instructors</h2>
    <div class="flex">
        <div>
            <h3>Add/Update Instructor</h3>
            <form method="post" onsubmit="return confirmInstructorUpdate(this);">
                <input type="hidden" name="action" value="create_instructor">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="confirm_update" id="instructor_confirm_update" value="0">
                <label>Instructor ID
                    <input type="text" name="instructor_id" id="instructor_id" placeholder="001" required pattern="[0-9]{3}" title="Must be exactly 3 digits">
                </label>
                <label>Name
                    <input type="text" name="instructor_name" id="instructor_name" placeholder="Dr. Ada Byron" required>
                </label>
                <button type="submit">Save Instructor</button>
            </form>
            <p class="help-text">
                <strong>Note:</strong> If instructor ID already exists, their name will be updated.
            </p>
        </div>
        <div>
            <h3>Faculty Directory</h3>
            <table>
                <tr><th>ID</th><th>Name</th><th></th></tr>
                {% for inst in instructors %}
                    <tr>
                        <td>{{ inst.instructor_id }}</td>
                        <td>{{ inst.name }}</td>
                        <td>
                            <form method="post" data-delete-instructor data-instructor-id="{{ inst.instructor_id }}" data-instructor-name="{{ inst.name|e }}" style="display:inline;">
                                <input type="hidden" name="action" value="delete_instructor">
                                <input type="hidden" name="instructor_id" value="{{ inst.instructor_id }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="secondary">Delete</button>
                            </form>
                            <button type="button" data-fill-instructor data-instructor-id="{{ inst.instructor_id }}" data-instructor-name="{{ inst.name|e }}" class="secondary">Edit</button>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
</div>

<script id="instructors-data" type="application/json">
{{ instructors|tojson }}
</script>
<script>
// Parse rendered JSON so this block remains valid JavaScript for editors/linters
const instructorsData = JSON.parse(document.getElementById('instructors-data').textContent);
const existingInstructors = Object.fromEntries(
    instructorsData.map(({ instructor_id, name }) => [
        instructor_id || "",
        name || ""
    ])
);
const instructorNameOwners = Object.fromEntries(
    instructorsData.map(({ instructor_id, name }) => [
        name || "",
        instructor_id || ""
    ])
);

function fillInstructor(id, name) {
    document.getElementById('instructor_id').value = id;
    document.getElementById('instructor_name').value = name;
    document.getElementById('instructor_id').focus();
}

function confirmInstructorUpdate(form) {
    const id = form.instructor_id.value.trim();
    const newName = form.instructor_name.value.trim();
    form.instructor_confirm_update.value = "0";
    
    // Warn if another instructor already uses this name
    const otherId = instructorNameOwners[newName];
    if (otherId && otherId !== id) {
        return confirm(`"${newName}" is already assigned to ID ${otherId}. Save anyway?`);
    }

    // Check if ID exists
    if (existingInstructors[id]) {
        const currentName = existingInstructors[id];
        if (currentName !== newName) {
            const proceed = confirm(
                `Instructor ID ${id} is currently assigned to:\n"${currentName}"\n\n` +
                `Are you sure you want to update the name to:\n"${newName}"?`
            );
            if (proceed) {
                form.instructor_confirm_update.value = "1";
            }
            return proceed;
        }
    }
    return true; // New instructor or no change
}

// Wire up edit buttons without embedding template expressions in JS
document.querySelectorAll('[data-fill-instructor]').forEach(btn => {
    btn.addEventListener('click', () => {
        fillInstructor(btn.dataset.instructorId, btn.dataset.instructorName);
    });
});

// Confirm deletes without embedding template expressions in JS
document.querySelectorAll('[data-delete-instructor]').forEach(form => {
    form.addEventListener('submit', event => {
        const name = form.dataset.instructorName || "this instructor";
        const id = form.dataset.instructorId || "";
        const message = id ? `Delete ${name} (ID: ${id})?` : `Delete ${name}?`;
        if (!confirm(message)) {
            event.preventDefault();
        }
    });
});
</script>

<style>
.help-text {
    font-size: 0.9em;
    color: #666;
    margin-top: 1em;
    padding: 0.5em;
    background: #f0f0f0;
    border-radius: 4px;
}
</style>
{% endblock %}
