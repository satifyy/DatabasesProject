{% extends "base.html" %}
{% block title %}Reports{% endblock %}
{% block content %}
<div class="card">
    <h2>Reports Menu</h2>
    <div class="flex" style="gap:1rem; flex-wrap:wrap;">
        <a href="{{ url_for('reports', view='degree') }}" class="button-link">Degree Queries</a>
        <a href="{{ url_for('reports', view='course') }}" class="button-link">Course Sections by Semester Range</a>
        <a href="{{ url_for('reports', view='instructor') }}" class="button-link">Instructor History</a>
        <a href="{{ url_for('reports', view='evaluation') }}" class="button-link">Evaluation Status by Semester</a>
        <a href="{{ url_for('reports', view='nonf') }}" class="button-link">Sections Meeting Non-F Threshold</a>
    </div>
</div>

{% if selected_report == 'degree' %}
<div class="card">
    <h2 id="degree-queries">Degree Queries</h2>
    <form method="post" class="flex" style="align-items:flex-end;">
        <input type="hidden" name="action" value="degree_report">
        <input type="hidden" name="view" value="degree">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
            <label>Degree</label>
            <select name="degree_name">
                {% for deg in degrees %}
                    <option value="{{ deg.name }}" {% if degree_filters.degree_name == deg.name %}selected{% endif %}>{{ deg.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Level</label>
            <select name="degree_level">
                {% for level in level_options %}
                    <option value="{{ level }}" {% if degree_filters.degree_level == level %}selected{% endif %}>{{ level }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Start Year</label>
            <input type="number" name="start_year" value="{{ degree_filters.start_year }}" required>
        </div>
        <div>
            <label>Start Term</label>
            <select name="start_term">
                {% for term in term_options %}
                    <option value="{{ term }}" {% if degree_filters.start_term == term %}selected{% endif %}>{{ term }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>End Year</label>
            <input type="number" name="end_year" value="{{ degree_filters.end_year }}" required>
        </div>
        <div>
            <label>End Term</label>
            <select name="end_term">
                {% for term in term_options %}
                    <option value="{{ term }}" {% if degree_filters.end_term == term %}selected{% endif %}>{{ term }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button type="submit">Run Degree Report</button>
        </div>
    </form>
    {% if report_data.degree_report %}
        <div class="flex">
            <div>
                <h3>Courses in Degree</h3>
                <table>
                    <tr><th>Course</th><th>Title</th><th>Core?</th></tr>
                    {% for row in report_data.degree_report.courses %}
                        <tr>
                            <td>{{ row.course_no }}</td>
                            <td>{{ row.title }}</td>
                            <td>{{ 'Yes' if row.is_core else 'No' }}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            <div>
                <h3>Objectives</h3>
                <table>
                    <tr><th>Code</th><th>Title</th></tr>
                    {% for row in report_data.degree_report.objectives %}
                        <tr><td>{{ row.code }}</td><td>{{ row.title }}</td></tr>
                    {% endfor %}
                </table>
            </div>
        </div>
        <h3>Sections in Range</h3>
        <table>
            <tr><th>Course</th><th>Title</th><th>Section</th><th>Semester</th><th>Instructor</th><th>Enrolled</th></tr>
            {% for row in report_data.degree_report.sections %}
                <tr>
                    <td>{{ row.course_no }}</td>
                    <td>{{ row.title }}</td>
                    <td>{{ row.section_no }}</td>
                    <td>{{ row.term }} {{ row.year }}</td>
                    <td>{{ row.instructor_name }}</td>
                    <td>{{ row.enrolled_count }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
</div>
{% elif selected_report == 'course' %}

<div class="card">
    <h2 id="course-sections">Course Sections by Semester Range</h2>
    <form method="post" class="flex" style="align-items:flex-end;">
        <input type="hidden" name="action" value="course_report">
        <input type="hidden" name="view" value="course">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
            <label>Course</label>
            <select name="course_no">
                {% for course in courses %}
                    <option value="{{ course.course_no }}" {% if course_filters.course_no == course.course_no %}selected{% endif %}>{{ course.course_no }} â€“ {{ course.title }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Start Year</label>
            <input type="number" name="course_start_year" value="{{ course_filters.start_year }}" required>
        </div>
        <div>
            <label>Start Term</label>
            <select name="course_start_term">
                {% for term in term_options %}
                    <option value="{{ term }}" {% if course_filters.start_term == term %}selected{% endif %}>{{ term }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>End Year</label>
            <input type="number" name="course_end_year" value="{{ course_filters.end_year }}" required>
        </div>
        <div>
            <label>End Term</label>
            <select name="course_end_term">
                {% for term in term_options %}
                    <option value="{{ term }}" {% if course_filters.end_term == term %}selected{% endif %}>{{ term }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button type="submit">Run Course Report</button>
        </div>
    </form>
    {% if report_data.course_report %}
        <table>
            <tr><th>Semester</th><th>Section</th><th>Instructor</th><th>Enrolled</th></tr>
            {% for row in report_data.course_report.rows %}
                <tr>
                    <td>{{ row.term }} {{ row.year }}</td>
                    <td>{{ row.section_no }}</td>
                    <td>{{ row.instructor_name }}</td>
                    <td>{{ row.enrolled_count }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
</div>
{% elif selected_report == 'instructor' %}

<div class="card">
    <h2 id="instructor-history">Instructor History</h2>
    <form method="post" class="flex" style="align-items:flex-end;">
        <input type="hidden" name="action" value="instructor_report">
        <input type="hidden" name="view" value="instructor">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
            <label>Instructor</label>
            <select name="report_instructor">
                {% for inst in instructors %}
                    <option value="{{ inst.instructor_id }}" {% if instructor_filters.instructor_id == inst.instructor_id %}selected{% endif %}>{{ inst.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Start Year</label>
            <input type="number" name="instructor_start_year" value="{{ instructor_filters.start_year }}" required>
        </div>
        <div>
            <label>Start Term</label>
            <select name="instructor_start_term">
                {% for term in term_options %}
                    <option value="{{ term }}" {% if instructor_filters.start_term == term %}selected{% endif %}>{{ term }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>End Year</label>
            <input type="number" name="instructor_end_year" value="{{ instructor_filters.end_year }}" required>
        </div>
        <div>
            <label>End Term</label>
            <select name="instructor_end_term">
                {% for term in term_options %}
                    <option value="{{ term }}" {% if instructor_filters.end_term == term %}selected{% endif %}>{{ term }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button type="submit">Run Instructor Report</button>
        </div>
    </form>
    {% if report_data.instructor_report %}
        <table>
            <tr><th>Course</th><th>Title</th><th>Section</th><th>Semester</th><th>Enrolled</th></tr>
            {% for row in report_data.instructor_report.rows %}
                <tr>
                    <td>{{ row.course_no }}</td>
                    <td>{{ row.title }}</td>
                    <td>{{ row.section_no }}</td>
                    <td>{{ row.term }} {{ row.year }}</td>
                    <td>{{ row.enrolled_count }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
</div>
{% elif selected_report == 'evaluation' %}

<div class="card">
    <h2 id="evaluation-status">Evaluation Status by Semester</h2>
    <form method="post" class="flex" style="align-items:flex-end;">
        <input type="hidden" name="action" value="evaluation_status">
        <input type="hidden" name="view" value="evaluation">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
            <label>Year</label>
            <input type="number" name="status_year" value="{{ eval_status_filters.year }}" required>
        </div>
        <div>
            <label>Term</label>
            <select name="status_term">
                {% for term in term_options %}
                    <option value="{{ term }}" {% if eval_status_filters.term == term %}selected{% endif %}>{{ term }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button type="submit">Run Evaluation Status</button>
        </div>
    </form>
    {% if report_data.evaluation_status %}
        <table>
            <tr><th>Course</th><th>Title</th><th>Section</th><th>Semester</th><th>Instructor</th><th>Enrolled</th><th>Status</th><th>Improvement?</th></tr>
            {% for row in report_data.evaluation_status.rows %}
                <tr>
                    <td>{{ row.course_no }}</td>
                    <td>{{ row.title }}</td>
                    <td>{{ row.section_no }}</td>
                    <td>{{ row.term }} {{ row.year }}</td>
                    <td>{{ row.instructor_name }}</td>
                    <td>{{ row.enrolled_count }}</td>
                    <td>{{ row.status }}</td>
                    <td>{{ 'Yes' if row.has_improvement else 'No' }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
</div>
{% elif selected_report == 'nonf' %}

<div class="card">
    <h2 id="nonf-threshold">Sections Meeting Non-F Threshold</h2>
    <form method="post" class="flex" style="align-items:flex-end;">
        <input type="hidden" name="action" value="nonf_report">
        <input type="hidden" name="view" value="nonf">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
            <label>Year</label>
            <input type="number" name="nonf_year" value="{{ nonf_filters.year }}" required>
        </div>
        <div>
            <label>Term</label>
            <select name="nonf_term">
                {% for term in term_options %}
                    <option value="{{ term }}" {% if nonf_filters.term == term %}selected{% endif %}>{{ term }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Threshold (0-1)</label>
            <input type="number" step="0.05" min="0" max="1" name="threshold" value="{{ nonf_filters.threshold }}">
        </div>
        <div>
            <button type="submit">Run Non-F Report</button>
        </div>
    </form>
    {% if report_data.nonf_report %}
        <table>
            <tr><th>Course</th><th>Title</th><th>Section</th><th>Semester</th><th>Instructor</th><th>Enrolled</th><th>Non-F</th><th>Total</th><th>% Non-F</th></tr>
            {% for row in report_data.nonf_report.rows %}
                <tr>
                    <td>{{ row.course_no }}</td>
                    <td>{{ row.title }}</td>
                    <td>{{ row.section_no }}</td>
                    <td>{{ row.term }} {{ row.year }}</td>
                    <td>{{ row.instructor_name }}</td>
                    <td>{{ row.enrolled_count }}</td>
                    <td>{{ row.nonf }}</td>
                    <td>{{ row.total }}</td>
                    <td>{{ '%.1f'|format(row.percent) }}%</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
</div>
{% endif %}
{% endblock %}
