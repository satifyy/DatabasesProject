{% extends "base.html" %}
{% block title %}Manage Courses{% endblock %}
{% block content %}
<div class="card">
    <h2>Courses</h2>
    <div class="flex">
        <div>
            <h3>Create / Update Course</h3>
            <form method="post" onsubmit="return confirmCourseUpdate(this);">
                <input type="hidden" name="action" value="create_course">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="confirm_update" id="course_confirm_update" value="0">
                <label>Course Number
                    <input type="text" name="course_no" id="course_no" placeholder="CS1010" required pattern="[A-Za-z]{2,4}[0-9]{4}" title="2-4 letters followed by 4 digits">
                </label>
                <label>Title
                    <input type="text" name="course_title" id="course_title" placeholder="Intro to Programming" required maxlength="120">
                </label>
                <label>Description
                    <textarea name="course_description" id="course_description" placeholder="Optional catalog description"></textarea>
                </label>
                <button type="submit">Save Course</button>
            </form>
            <p class="help-text">
                <strong>Note:</strong> If course number already exists, title and description will be updated.
            </p>
        </div>
        <div>
            <h3>Catalog</h3>
            <table>
                <tr><th>Course</th><th>Title</th><th></th></tr>
                {% for course in courses %}
                    <tr>
                        <td>{{ course.course_no }}</td>
                        <td>{{ course.title }}</td>
                        <td>
                            <form method="post" data-delete-course data-course-no="{{ course.course_no }}" data-course-title="{{ course.title|e }}" style="display:inline;">
                                <input type="hidden" name="action" value="delete_course">
                                <input type="hidden" name="course_no" value="{{ course.course_no }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="secondary">Delete</button>
                            </form>
                            <button type="button" data-fill-course data-course-no="{{ course.course_no }}" data-course-title="{{ course.title|e }}" data-course-description="{{ (course.description or '')|e }}" class="secondary">Edit</button>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
</div>

<script id="courses-data" type="application/json">
{{ courses|tojson }}
</script>
<script>
// Parse rendered JSON so this block remains valid JavaScript for editors/linters
const coursesData = JSON.parse(document.getElementById('courses-data').textContent);
const existingCourses = Object.fromEntries(
    coursesData.map(({ course_no, title, description }) => [
        (course_no || "").toUpperCase(),
        { title: title || "", description: description || "" }
    ])
);
const courseTitleOwners = Object.fromEntries(
    coursesData.map(({ course_no, title }) => [
        title || "",
        (course_no || "").toUpperCase()
    ])
);

function fillCourse(courseNo, title, description) {
    document.getElementById('course_no').value = courseNo;
    document.getElementById('course_title').value = title;
    document.getElementById('course_description').value = description;
    document.getElementById('course_no').focus();
}

function confirmCourseUpdate(form) {
    const courseNo = form.course_no.value.trim().toUpperCase();
    const newTitle = form.course_title.value.trim();
    form.course_no.value = courseNo;
    form.course_confirm_update.value = "0";
    
    // Check if course exists
    if (existingCourses[courseNo]) {
        const current = existingCourses[courseNo];
        if (current.title !== newTitle) {
            const proceed = confirm(
                `Course ${courseNo} is currently:\n"${current.title}"\n\n` +
                `Are you sure you want to update the title to:\n"${newTitle}"?`
            );
            if (proceed) {
                form.course_confirm_update.value = "1";
            }
            return proceed;
        }
    }
    // Warn if another course already uses this title
    const otherCourse = courseTitleOwners[newTitle];
    if (otherCourse && otherCourse !== courseNo) {
        return confirm(`The title "${newTitle}" is already used by course ${otherCourse}. Save anyway?`);
    }
    return true; // New course or no change
}

// Wire up edit buttons without embedding template expressions in JS
document.querySelectorAll('[data-fill-course]').forEach(btn => {
    btn.addEventListener('click', () => {
        fillCourse(btn.dataset.courseNo, btn.dataset.courseTitle, btn.dataset.courseDescription);
    });
});

// Confirm deletes without embedding template expressions in JS
document.querySelectorAll('[data-delete-course]').forEach(form => {
    form.addEventListener('submit', event => {
        const title = form.dataset.courseTitle || "this course";
        const no = form.dataset.courseNo || "";
        const message = no ? `Delete ${no}: ${title}?` : `Delete ${title}?`;
        if (!confirm(message)) {
            event.preventDefault();
        }
    });
});
</script>

<style>
.help-text {
    font-size: 0.9em;
    color: #666;
    margin-top: 1em;
    padding: 0.5em;
    background: #f0f0f0;
    border-radius: 4px;
}
</style>
{% endblock %}
